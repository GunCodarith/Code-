#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// ตั้งค่าจอ LCD I2C Address 0x26
LiquidCrystal_I2C lcd(0x26, 16, 2);

// ===== ตั้งค่าขาให้ตรงกับรูปภาพ =====
// เรียงลำดับ: ซ้าย -> กลาง -> ขวา

// ไฟ LED (ซ้าย=ขา4, กลาง=ขา3, ขวา=ขา2)
const int ledPins[3] = {4, 3, 2};   

// ปุ่มกด (ซ้าย=ขา8, กลาง=ขา9, ขวา=ขา10)
const int btnPins[3] = {8, 9, 10};  
// =================================

int answer = -1;
bool gameStarted = false;
const unsigned long pressTimeLimit = 1500; // เวลา 1 วินาที

void setup() {
  // ตั้งค่าขา
  for (int i = 0; i < 3; i++) {
    pinMode(ledPins[i], OUTPUT);
    pinMode(btnPins[i], INPUT_PULLUP); // ใช้ Pull-up ภายใน (กด = LOW)
  }

  // เริ่มต้นจอ LCD
  lcd.init();
  lcd.backlight();

  // สุ่มค่าเริ่มต้น (ใช้ขา A0 ที่ลอยอยู่เป็นตัวช่วยสุ่ม)
  randomSeed(analogRead(A0));

  showStartScreen();
}

void loop() {
  // 1. หน้าจอรอเริ่มเกม
  if (!gameStarted) {
    for (int i = 0; i < 3; i++) {
      if (digitalRead(btnPins[i]) == LOW) {
        delay(50); // กันสั่น
        waitRelease(i); 
        gameStarted = true;
        startGame(); 
      }
    }
    return;
  }

  // 2. ช่วงจับเวลา
  unsigned long startTime = millis();
  bool pressed = false;

  while (millis() - startTime < pressTimeLimit) {
    for (int i = 0; i < 3; i++) {
      if (digitalRead(btnPins[i]) == LOW) { // มีปุ่มถูกกด
        waitRelease(i); 

        // ตรวจคำตอบ
        if (i == answer) {
          showDice(); // ถูกต้อง
        } else {
          showFail(); // ผิด
        }

        resetGame(); 
        pressed = true;
        return; 
      }
    }
  }

  // 3. หมดเวลา
  if (!pressed) {
    showFail();
    resetGame();
  }
}

// ================= ฟังก์ชันช่วยทำงาน =================

void showStartScreen() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Reflex Game");
  lcd.setCursor(0, 1);
  lcd.print("Press Any Btn");
}

void startGame() {
  lcd.clear();
  lcd.print("Memorize!"); 

  answer = random(0, 3); // สุ่ม 0, 1, หรือ 2
  digitalWrite(ledPins[answer], HIGH); // เปิดไฟโจทย์

  delay(1000); // ให้เวลาจำ 1 วินาที

  digitalWrite(ledPins[answer], LOW); // ปิดไฟ

  lcd.clear();
  lcd.print("Press Button!"); 
}

void showDice() {
  lcd.clear();
  lcd.print("Dice Roll:");

  int dice = random(1, 21); // สุ่มเลข 1-20

  lcd.setCursor(0, 1);
  lcd.print("Result: ");
  lcd.print(dice);

  // เอฟเฟกต์ไฟวิ่งฉลองชัยชนะ (ซ้ายไปขวา)
  for(int k=0; k<2; k++){
    for(int j=0; j<3; j++) { 
      digitalWrite(ledPins[j], HIGH); 
      delay(100); 
      digitalWrite(ledPins[j], LOW); 
    }
  }
  
  delay(1500); 
}

void showFail() {
  lcd.clear();
  lcd.print("FAIL !!!");
  
  // กระพริบไฟเฉลยว่าปุ่มไหนถูก
  for(int k=0; k<3; k++){
    digitalWrite(ledPins[answer], HIGH);
    delay(200);
    digitalWrite(ledPins[answer], LOW);
    delay(200);
  }
  delay(500);
}

void resetGame() {
  answer = -1;
  gameStarted = false;
  showStartScreen();
}

void waitRelease(int btnIndex) {
  while (digitalRead(btnPins[btnIndex]) == LOW) {
    delay(10);
  }
}
